---
title: "FinalCleaningAndExploration"
output: html_document
date: "2023-04-05"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r}
amsterdam_weekdays <- read.csv("amsterdam_weekdays.csv")
amsterdam_weekends <- read.csv("amsterdam_weekends.csv")
amsterdam <- bind_rows(amsterdam_weekdays, amsterdam_weekends, .id = 'set')
athens_weekdays <- read.csv("athens_weekdays.csv")
athens_weekends <- read.csv("athens_weekends.csv")
athens <- bind_rows(athens_weekdays, athens_weekends, .id = 'set')
barcelona_weekdays <- read.csv("barcelona_weekdays.csv")
barcelona_weekends <- read.csv("barcelona_weekends.csv")
barcelona <- bind_rows(barcelona_weekdays, barcelona_weekends, .id = 'set')
berlin_weekdays <- read.csv("berlin_weekdays.csv")
berlin_weekends <- read.csv("berlin_weekends.csv")
berlin <- bind_rows(berlin_weekdays, berlin_weekends, .id = 'set')
budapest_weekdays <- read.csv("budapest_weekdays.csv")
budapest_weekends <- read.csv("budapest_weekends.csv")
budapest <- bind_rows(budapest_weekdays, budapest_weekends, .id = 'set')
lisbon_weekdays <- read.csv("lisbon_weekdays.csv")
lisbon_weekends <- read.csv("lisbon_weekends.csv")
lisbon <- bind_rows(lisbon_weekdays, lisbon_weekends, .id = 'set')
london_weekdays <- read.csv("london_weekdays.csv")
london_weekends <- read.csv("london_weekends.csv")
london <- bind_rows(london_weekdays, london_weekends, .id = 'set')
paris_weekdays <- read.csv("paris_weekdays.csv")
paris_weekends <- read.csv("paris_weekends.csv")
paris <- bind_rows(paris_weekdays, paris_weekends, .id = 'set')
rome_weekdays <- read.csv("rome_weekdays.csv")
rome_weekends <- read.csv("rome_weekends.csv")
rome <- bind_rows(rome_weekdays, rome_weekends, .id = 'set')
vienna_weekdays <- read.csv("vienna_weekdays.csv")
vienna_weekends <- read.csv("vienna_weekends.csv")
vienna <- bind_rows(vienna_weekdays, vienna_weekends, .id = 'set')
summary(amsterdam)
```

```{r}
library(cluster)    # clustering algorithms
library(factoextra)
set.seed(2003)
amsterdam_spatial <- amsterdam[,c(3,14:21)]
athens_spatial <- athens[,c(3,14:21)]
barcelona_spatial <- barcelona[,c(3,14:21)]
berlin_spatial <- berlin[,c(3,14:21)]
budapest_spatial <- budapest[,c(3,14:21)]
lisbon_spatial <- lisbon[,c(3,14:21)]
london_spatial <- london[,c(3,14:21)]
paris_spatial <- paris[,c(3,14:21)]
rome_spatial <- rome[,c(3,14:21)]
vienna_spatial <- vienna[,c(3,14:21)]
summary(amsterdam_spatial)
```

```{r}
k <- kmeans(amsterdam_spatial, centers = 4, nstart = 25)
fviz_cluster(k, data = amsterdam_spatial)
```
```{r}
# function to compute average silhouette for k clusters
avg_sil <- function(k) {
  km.res <- kmeans(amsterdam_spatial, centers = k, nstart = 25)
  ss <- silhouette(km.res$cluster, dist(amsterdam_spatial))
  mean(ss[, 3])
}

# Compute and plot wss for k = 2 to k = 15
k.values <- 2:15

# extract avg silhouette for 2-15 clusters
avg_sil_values <- map_dbl(k.values, avg_sil)

plot(k.values, avg_sil_values,
       type = "b", pch = 19, frame = FALSE, 
       xlab = "Number of clusters K",
       ylab = "Average Silhouettes")
```

```{r}
fviz_nbclust(amsterdam_spatial, kmeans, method = "silhouette")
fviz_nbclust(athens_spatial, kmeans, method = "silhouette")
fviz_nbclust(barcelona_spatial, kmeans, method = "silhouette")
fviz_nbclust(berlin_spatial, kmeans, method = "silhouette")
fviz_nbclust(budapest_spatial, kmeans, method = "silhouette")
fviz_nbclust(lisbon_spatial, kmeans, method = "silhouette")
fviz_nbclust(london_spatial, kmeans, method = "silhouette")
fviz_nbclust(paris_spatial, kmeans, method = "silhouette")
fviz_nbclust(rome_spatial, kmeans, method = "silhouette")
fviz_nbclust(vienna_spatial, kmeans, method = "silhouette")
```

```{r}

final_amsterdam <- kmeans(amsterdam_spatial, 4, nstart = 25)
final_amsterdam$cluster <- factor(final_amsterdam$cluster)
final_athens <- kmeans(athens_spatial, 2, nstart = 25)
final_athens$cluster <- factor(final_athens$cluster)
final_barcelona <- kmeans(barcelona_spatial, 3, nstart = 25)
final_barcelona$cluster <- factor(final_barcelona$cluster)
final_berlin <- kmeans(berlin_spatial, 2, nstart = 25)
final_berlin$cluster <- factor(final_berlin$cluster)
```

```{r}
amsterdam_spatial %>%
  mutate(Cluster = final_amsterdam$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
```

```{r}
library(shiny)
library(plotly)
library(ggplot2)

fig <- amsterdam_spatial
fig <- fig %>%
  plot_ly(
    lat = ~lat,
    lon = ~lng,
    mode = "markers",
    colors = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926"), 
    color = ~final_amsterdam$cluster,
    type = 'scattermapbox',
    hovertext = ~paste(realSum, "Price"),
    legendgroup = ~final_amsterdam$cluster, 
    showlegend = T)
fig <- fig %>%
  layout(
    mapbox = list(
      style = 'open-street-map',
      zoom =3,
      center = list(lon = 12, lat = 45))) 

fig2 <- athens_spatial
fig2 <- fig2 %>%
  plot_ly(
    lat = ~lat,
    lon = ~lng,
    mode = "markers",
    colors = c("1"="#ff595e", "2"="#ffca3a"),
    color = ~final_athens$cluster,
    type = 'scattermapbox',
    hovertext = ~paste(realSum, "Price") ,
    legendgroup = ~final_athens$cluster, 
    showlegend = F)
fig2 <- fig2 %>%
  layout(
    mapbox = list(
      style = 'open-street-map',
      zoom =3,
      center = list(lon = 12, lat = 45))) 

fig3 <- barcelona_spatial
fig3 <- fig3 %>%
  plot_ly(
    lat = ~lat,
    lon = ~lng,
    mode = "markers",
    colors = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4"),
    color = ~final_barcelona$cluster,
    type = 'scattermapbox',
    hovertext = ~paste(realSum, "Price") ,
    legendgroup = ~final_barcelona$cluster, 
    showlegend = F)
fig3 <- fig3 %>%
  layout(
    mapbox = list(
      style = 'open-street-map',
      zoom =3,
      center = list(lon = 12, lat = 45))) 

fig4 <- berlin_spatial
fig4 <- fig4 %>%
  plot_ly(
    lat = ~lat,
    lon = ~lng,
    mode = "markers",
    colors = c("1"="#ff595e", "2"="#ffca3a"),
    color = ~final_berlin$cluster,
    type = 'scattermapbox',
    hovertext = ~paste(realSum, "Price") ,
    legendgroup = ~final_berlin$cluster, 
    showlegend = F)
fig4 <- fig4 %>%
  layout(
    mapbox = list(
      style = 'open-street-map',
      zoom =3,
      center = list(lon = 12, lat = 45))) 

#fig <- fig %>%
#  add_trace(fig2) # adds the line trace to the first figure

fig <- subplot(fig, fig2, fig3, fig4)

fig
```
