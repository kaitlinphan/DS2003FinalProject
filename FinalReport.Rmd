---
title: "FinalReport"
output:
     html_document:
          number_sections: yes
          toc: TRUE
          toc_depth: 4
          toc_float: true
          toc_collapsed: true
          theme: journal
          code_folding: hide
runtime: shiny  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(kableExtra)
library(plotly)
library(cluster)    # clustering algorithms
library(factoextra)
library(ggplot2)
library(GGally)
```
# Title
Examining Economic and Spatial Determinants in Airbnb Price Trends in European Cities

# Abstract
Global travel is the foundation to many important economic sectors such as international business and tourism. In this analysis, the research objective was to identify trends among European Airbnb rentals across 10 major metropolitan areas. In order to guide this report, the following questions will be asked: What are the spatial trends between attractions and location for Airbnb prices within various European cities? How do rental rates for Airbnb bookings compare for vacationers and business travelers?

## Introduction
The COVID-19 pandemic had unprecedented effects on the global economy, particularly within those industries that relied heavily on travel. Tourism was one of the first sectors to be deeply impacted by the pandemic, as measures introduced to contain the novel virus led to a near-complete cessation of tourism activities around the world. Lockdowns and health measures during the pandemic disrupted non-essential travel and placed an international halt on the normal activities within many business and tourism centers. Despite the revolution in vaccines that have mitigated the spread of coronavirus, the outlook for the tourism sector remains highly uncertain and risks being among one of the last to recover with ongoing travel restrictions and a potential global recession in 2023. Destinations that rely heavily on international, business, and event tourism are struggling. Beyond the tourism economy, this uncertainty in economic performance has far reaching implications as many other sectors that support (and are supported by) tourism are significantly impacted. 

In 2022, however, the first indications of a global recovery became apparent. The total number of nights spent in tourist accommodations in 2022 was close to the pre-pandemic level – 2.72 billion nights in 2022 compared with 2.88 billion in 2019 – illustrating a strong (but not total) recovery from the pandemic [1]. Between January and September, an estimated 700 million tourists traveled internationally, more than double the number recorded for the same period in 2021 [2]. These results were boosted by strong pent-up demand, improved confidence levels, and the lifting of restrictions in an increasing number of countries. Europe in particular continues to lead the rebound of international tourism. The region welcomed 477 million international arrivals in 2022, a figure which represents 81% of its pre-pandemic levels [2]. The robust recovery of tourism is also reflected in various industry indicators such as hotel metrics in which Europe is also a leader. With respect to the growth that Europe experienced following the pandemic, it is pertinent to study the relationships between various metrics within the tourism industry because of their relevance to global economic recovery and local development. 

As one of the most visited travel and tourism websites, the popularity and prevalence of data from Airbnb supports its utilization within this investigative report. An accurate assessment of Airbnb price determinants is essential not only for tourism management in the aftermath of COVID-19, but also for further economic development through urban planning. Airbnb is increasingly turning into a professional source of income, with hosts transforming housing supply into tourist accommodations. Therefore, gaining a better understanding of the role of location in the price premium has considerable policy relevance, in addition to financial significance as well. 


# Dataset
The dataset we used is about Airbnbs in ten European cities. The data was collected in October of 2021. In order to collect Airbnb offers that would be presented to a real user, with use of a web-automation framework (Selenium WebDriver), search queries were executed on the Airbnb platform that referred to accommodations in 10 major European cities for two people and two nights. The offers were collected four to six weeks in advance of the travel dates, and the collected prices refer to the full amount due for the accommodation, including the reservation fee and cleaning fee. For each city, two datasets were prepared, including offers for weekdays (Tuesday-Thursday) and weekends (Friday-Sunday).

A table describing the variables contained within this dataset is found below:

```{r}
dataset_table <- read.csv("DatasetTable.csv")
dataset_table %>%
  kbl(caption = "Variables Used") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

Variables We Did Not Use:


* Multi - whether the listing is for multiple rooms or not

* Cleanliness_rating - The cleanliness rating of the listing

* Guest_satisfaction_overall - The overall guest satisfaction rating of the listing

* Bedrooms - The number of bedrooms in the listing


We did not use these variables because we saw stronger potential for analyses of the other variables. These variables focused more on insignificant details of the listings that would not help in answering our questions. We had to narrow the details of the listing and saw more of a need for what type of rooms the listing consists of, the capacity of the listing, and the spatial variables (distance from city center and metro, attraction index, restaurant index). We felt these would contribute more to what customers may look into when searching for listings. 

```{r}
# Add weekday/weekend label to dataframes
amsterdam_weekdays <- read.csv("amsterdam_weekdays.csv")
amsterdam_weekdays <- amsterdam_weekdays %>%
  add_column(dayofweek = "weekday")
amsterdam_weekends <- read.csv("amsterdam_weekends.csv")
amsterdam_weekends <- amsterdam_weekends %>%
  add_column(dayofweek = "weekend")
athens_weekdays <- read.csv("athens_weekdays.csv")
athens_weekdays <- athens_weekdays %>%
  add_column(dayofweek = "weekday")
athens_weekends <- read.csv("athens_weekends.csv")
athens_weekends <- athens_weekends %>%
  add_column(dayofweek = "weekend")
barcelona_weekdays <- read.csv("barcelona_weekdays.csv")
barcelona_weekdays <- barcelona_weekdays %>%
  add_column(dayofweek = "weekday")
barcelona_weekends <- read.csv("barcelona_weekends.csv")
barcelona_weekends <- barcelona_weekends %>%
  add_column(dayofweek = "weekend")
berlin_weekdays <- read.csv("berlin_weekdays.csv")
berlin_weekdays <- berlin_weekdays %>%
  add_column(dayofweek = "weekday")
berlin_weekends <- read.csv("berlin_weekends.csv")
berlin_weekends <- berlin_weekends %>%
  add_column(dayofweek = "weekend")
budapest_weekdays <- read.csv("budapest_weekdays.csv")
budapest_weekdays <- budapest_weekdays %>%
  add_column(dayofweek = "weekday")
budapest_weekends <- read.csv("budapest_weekends.csv")
budapest_weekends <- budapest_weekends %>%
  add_column(dayofweek = "weekend")
lisbon_weekdays <- read.csv("lisbon_weekdays.csv")
lisbon_weekdays <- lisbon_weekdays %>%
  add_column(dayofweek = "weekday")
lisbon_weekends <- read.csv("lisbon_weekends.csv")
lisbon_weekends <- lisbon_weekends %>%
  add_column(dayofweek = "weekend")
london_weekdays <- read.csv("london_weekdays.csv")
london_weekdays <- london_weekdays %>%
  add_column(dayofweek = "weekday")
london_weekends <- read.csv("london_weekends.csv")
london_weekends <- london_weekends %>%
  add_column(dayofweek = "weekend")
paris_weekdays <- read.csv("paris_weekdays.csv")
paris_weekdays <- paris_weekdays %>%
  add_column(dayofweek = "weekday")
paris_weekends <- read.csv("paris_weekends.csv")
paris_weekends <-  paris_weekends %>%
  add_column(dayofweek = "weekend")
rome_weekdays <- read.csv("rome_weekdays.csv")
rome_weekdays <- rome_weekdays %>%
  add_column(dayofweek = "weekday")
rome_weekends <- read.csv("rome_weekends.csv")
rome_weekends <-  rome_weekends %>%
  add_column(dayofweek = "weekend")
vienna_weekdays <- read.csv("vienna_weekdays.csv")
vienna_weekdays <- vienna_weekdays %>%
  add_column(dayofweek = "weekday")
vienna_weekends <- read.csv("vienna_weekends.csv")
vienna_weekends <-  vienna_weekends %>%
  add_column(dayofweek = "weekend")

# Combine datasets
amsterdam <- bind_rows(amsterdam_weekdays, amsterdam_weekends)
athens <- bind_rows(athens_weekdays, athens_weekends)
barcelona <- bind_rows(barcelona_weekdays, barcelona_weekends)
berlin <- bind_rows(berlin_weekdays, berlin_weekends)
budapest <- bind_rows(budapest_weekdays, budapest_weekends)
lisbon <- bind_rows(lisbon_weekdays, lisbon_weekends)
london <- bind_rows(london_weekdays, london_weekends)
paris <- bind_rows(paris_weekdays, paris_weekends)
rome <- bind_rows(rome_weekdays, rome_weekends)
vienna <- bind_rows(vienna_weekdays, vienna_weekends)

# Add city names to the dataframes
amsterdam <- amsterdam %>%
  add_column(city = "amsterdam")
athens <- athens %>%
  add_column(city = "athens")
barcelona <- barcelona %>%
  add_column(city = "barcelona")
berlin <- berlin %>%
  add_column(city = "berlin")
budapest <- budapest %>%
  add_column(city = "budapest")
lisbon <- lisbon %>%
  add_column(city = "lisbon")
london <- london %>%
  add_column(city = "london")
paris <- paris %>%
  add_column(city = "paris")
rome <- rome %>%
  add_column(city = "rome")
vienna <- vienna %>%
  add_column(city = "vienna")
```

# Question 1
What are the spatial trends between attractions and location for Airbnb prices within various European cities?

## Chart
```{r}
set.seed(2003)

#find Q1, Q3, and interquartile range for values in column A
Q1_amsterdam <- quantile(amsterdam_weekends$realSum, .25)
Q3_amsterdam <- quantile(amsterdam_weekends$realSum, .75)
IQR_amsterdam <- IQR(amsterdam_weekends$realSum)
#only keep rows in dataframe that have values within 1.5*IQR of Q1 and Q3
amsterdam_spatial_no_outliers <- subset(amsterdam_weekends, amsterdam_weekends$realSum> (Q1_amsterdam - 1.5*IQR_amsterdam) & amsterdam_weekends$realSum< (Q3_amsterdam + 1.5*IQR_amsterdam))
amsterdam_spatial_no_outliers <- amsterdam_spatial_no_outliers[,c(2,13:20)]

Q1_athens <- quantile(athens_weekends$realSum, .25)
Q3_athens <- quantile(athens_weekends$realSum, .75)
IQR_athens <- IQR(athens_weekends$realSum)
athens_spatial_no_outliers <- subset(athens_weekends, athens_weekends$realSum> (Q1_athens - 1.5*IQR_athens) & athens_weekends$realSum< (Q3_athens + 1.5*IQR_athens))
athens_spatial_no_outliers <- athens_spatial_no_outliers[,c(2,13:20)]

Q1_barcelona <- quantile(barcelona_weekends$realSum, .25)
Q3_barcelona <- quantile(barcelona_weekends$realSum, .75)
IQR_barcelona <- IQR(barcelona_weekends$realSum)
barcelona_spatial_no_outliers <- subset(barcelona_weekends, barcelona_weekends$realSum> (Q1_barcelona - 1.5*IQR_barcelona) & barcelona_weekends$realSum< (Q3_barcelona + 1.5*IQR_barcelona))
barcelona_spatial_no_outliers <- barcelona_spatial_no_outliers[,c(2,13:20)]

Q1_berlin <- quantile(berlin_weekends$realSum, .25)
Q3_berlin <- quantile(berlin_weekends$realSum, .75)
IQR_berlin <- IQR(berlin_weekends$realSum)
berlin_spatial_no_outliers <- subset(berlin_weekends, berlin_weekends$realSum> (Q1_berlin - 1.5*IQR_berlin) & berlin_weekends$realSum< (Q3_berlin + 1.5*IQR_berlin))
berlin_spatial_no_outliers <- berlin_spatial_no_outliers[,c(2,13:20)]

Q1_budapest <- quantile(budapest_weekends$realSum, .25)
Q3_budapest <- quantile(budapest_weekends$realSum, .75)
IQR_budapest <- IQR(budapest_weekends$realSum)
budapest_spatial_no_outliers <- subset(budapest_weekends, budapest_weekends$realSum> (Q1_budapest - 1.5*IQR_budapest) & budapest_weekends$realSum< (Q3_budapest + 1.5*IQR_budapest))
budapest_spatial_no_outliers <- budapest_spatial_no_outliers[,c(2,13:20)]

Q1_lisbon <- quantile(lisbon_weekends$realSum, .25)
Q3_lisbon <- quantile(lisbon_weekends$realSum, .75)
IQR_lisbon <- IQR(lisbon_weekends$realSum)
lisbon_spatial_no_outliers <- subset(lisbon_weekends, lisbon_weekends$realSum> (Q1_lisbon - 1.5*IQR_lisbon) & lisbon_weekends$realSum< (Q3_lisbon + 1.5*IQR_lisbon))
lisbon_spatial_no_outliers <- lisbon_spatial_no_outliers[,c(2,13:20)]

Q1_london <- quantile(london_weekends$realSum, .25)
Q3_london <- quantile(london_weekends$realSum, .75)
IQR_london <- IQR(london_weekends$realSum)
london_spatial_no_outliers <- subset(london_weekends, london_weekends$realSum> (Q1_london - 1.5*IQR_london) & london_weekends$realSum< (Q3_london + 1.5*IQR_london))
london_spatial_no_outliers <- london_spatial_no_outliers[,c(2,13:20)]

Q1_paris <- quantile(paris_weekends$realSum, .25)
Q3_paris <- quantile(paris_weekends$realSum, .75)
IQR_paris <- IQR(paris_weekends$realSum)
paris_spatial_no_outliers <- subset(paris_weekends, paris_weekends$realSum> (Q1_paris - 1.5*IQR_paris) & paris_weekends$realSum< (Q3_paris + 1.5*IQR_paris))
paris_spatial_no_outliers <- paris_spatial_no_outliers[,c(2,13:20)]

Q1_rome <- quantile(rome_weekends$realSum, .25)
Q3_rome <- quantile(rome_weekends$realSum, .75)
IQR_rome <- IQR(rome_weekends$realSum)
rome_spatial_no_outliers <- subset(rome_weekends, rome_weekends$realSum> (Q1_rome - 1.5*IQR_rome) & rome_weekends$realSum< (Q3_rome + 1.5*IQR_rome))
rome_spatial_no_outliers <- rome_spatial_no_outliers[,c(2,13:20)]

Q1_vienna <- quantile(vienna_weekends$realSum, .25)
Q3_vienna <- quantile(vienna_weekends$realSum, .75)
IQR_vienna <- IQR(vienna_weekends$realSum)
vienna_spatial_no_outliers <- subset(vienna_weekends, vienna_weekends$realSum> (Q1_vienna - 1.5*IQR_vienna) & vienna_weekends$realSum< (Q3_vienna + 1.5*IQR_vienna))
vienna_spatial_no_outliers <- vienna_spatial_no_outliers[,c(2,13:20)]


final_amsterdam <- kmeans(amsterdam_spatial_no_outliers, 2, nstart = 25)
final_amsterdam$cluster <- factor(final_amsterdam$cluster)

final_athens <- kmeans(athens_spatial_no_outliers, 3, nstart = 25)
final_athens$cluster <- factor(final_athens$cluster)

final_barcelona <- kmeans(barcelona_spatial_no_outliers, 3, nstart = 25)
final_barcelona$cluster <- factor(final_barcelona$cluster)

final_berlin <- kmeans(berlin_spatial_no_outliers, 2, nstart = 25)
final_berlin$cluster <- factor(final_berlin$cluster)

final_budapest <- kmeans(budapest_spatial_no_outliers, 3, nstart = 25)
final_budapest$cluster <- factor(final_budapest$cluster)

final_lisbon <- kmeans(lisbon_spatial_no_outliers, 3, nstart = 25)
final_lisbon$cluster <- factor(final_lisbon$cluster)

final_london <- kmeans(london_spatial_no_outliers, 4, nstart = 25)
final_london$cluster <- factor(final_london$cluster)

final_paris <- kmeans(paris_spatial_no_outliers, 4, nstart = 25)
final_paris$cluster <- factor(final_paris$cluster)

final_rome <- kmeans(rome_spatial_no_outliers, 4, nstart = 25)
final_rome$cluster <- factor(final_rome$cluster)

final_vienna <- kmeans(vienna_spatial_no_outliers, 3, nstart = 25)
final_vienna$cluster <- factor(final_vienna$cluster)


amsterdam_spatial_no_outliers <- amsterdam_spatial_no_outliers %>%
  mutate(Cluster = final_amsterdam$cluster)

athens_spatial_no_outliers <- athens_spatial_no_outliers %>%
  mutate(Cluster = final_athens$cluster)

barcelona_spatial_no_outliers <- barcelona_spatial_no_outliers %>%
  mutate(Cluster = final_barcelona$cluster)

berlin_spatial_no_outliers <- berlin_spatial_no_outliers %>%
  mutate(Cluster = final_berlin$cluster)

budapest_spatial_no_outliers <- budapest_spatial_no_outliers %>%
  mutate(Cluster = final_budapest$cluster)

lisbon_spatial_no_outliers <- lisbon_spatial_no_outliers %>%
  mutate(Cluster = final_lisbon$cluster)

london_spatial_no_outliers <- london_spatial_no_outliers %>%
  mutate(Cluster = final_london$cluster)

paris_spatial_no_outliers <- paris_spatial_no_outliers %>%
  mutate(Cluster = final_paris$cluster)

rome_spatial_no_outliers <- rome_spatial_no_outliers %>%
  mutate(Cluster = final_rome$cluster)

vienna_spatial_no_outliers <- vienna_spatial_no_outliers %>%
  mutate(Cluster = final_vienna$cluster)

amsterdam_spatial_clusters <- amsterdam_spatial_no_outliers %>%
  mutate(Cluster = final_amsterdam$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
amsterdam_spatial_clusters <- amsterdam_spatial_clusters %>%
  add_column(city = "amsterdam")

athens_spatial_clusters <- athens_spatial_no_outliers %>%
  mutate(Cluster = final_athens$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
athens_spatial_clusters <- athens_spatial_clusters %>%
  add_column(city = "athens")

barcelona_spatial_clusters <- barcelona_spatial_no_outliers %>%
  mutate(Cluster = final_barcelona$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
barcelona_spatial_clusters <- barcelona_spatial_clusters %>%
  add_column(city = "barcelona")

berlin_spatial_clusters <- berlin_spatial_no_outliers %>%
  mutate(Cluster = final_berlin$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
berlin_spatial_clusters <- berlin_spatial_clusters %>%
  add_column(city = "berlin")

budapest_spatial_clusters <- budapest_spatial_no_outliers %>%
  mutate(Cluster = final_budapest$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
budapest_spatial_clusters <- budapest_spatial_clusters %>%
  add_column(city = "budapest")

lisbon_spatial_clusters <- lisbon_spatial_no_outliers %>%
  mutate(Cluster = final_lisbon$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
lisbon_spatial_clusters <- lisbon_spatial_clusters %>%
  add_column(city = "lisbon")

london_spatial_clusters <- london_spatial_no_outliers %>%
  mutate(Cluster = final_london$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
london_spatial_clusters <- london_spatial_clusters %>%
  add_column(city = "london")

paris_spatial_clusters <- paris_spatial_no_outliers %>%
  mutate(Cluster = final_paris$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
paris_spatial_clusters <- paris_spatial_clusters %>%
  add_column(city = "paris")

rome_spatial_clusters <- rome_spatial_no_outliers %>%
  mutate(Cluster = final_rome$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
rome_spatial_clusters <- rome_spatial_clusters %>%
  add_column(city = "rome")

vienna_spatial_clusters <- vienna_spatial_no_outliers %>%
  mutate(Cluster = final_vienna$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("median")
vienna_spatial_clusters <- vienna_spatial_clusters %>%
  add_column(city = "vienna")



amsterdam_spatial_no_outliers["attraction_rating"] <- cut(amsterdam_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
amsterdam_spatial_no_outliers <- amsterdam_spatial_no_outliers %>%
  add_column(city = "amsterdam")

athens_spatial_no_outliers["attraction_rating"] <- cut(athens_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
athens_spatial_no_outliers <- athens_spatial_no_outliers %>%
  add_column(city = "athens")

barcelona_spatial_no_outliers["attraction_rating"] <- cut(barcelona_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
barcelona_spatial_no_outliers <- barcelona_spatial_no_outliers %>%
  add_column(city = "barcelona")

berlin_spatial_no_outliers["attraction_rating"] <- cut(berlin_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
berlin_spatial_no_outliers <- berlin_spatial_no_outliers %>%
  add_column(city = "berlin")

budapest_spatial_no_outliers["attraction_rating"] <- cut(budapest_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
budapest_spatial_no_outliers <- budapest_spatial_no_outliers %>%
  add_column(city = "budapest")

lisbon_spatial_no_outliers["attraction_rating"] <- cut(lisbon_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
lisbon_spatial_no_outliers <- lisbon_spatial_no_outliers %>%
  add_column(city = "lisbon")

london_spatial_no_outliers["attraction_rating"] <- cut(london_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
london_spatial_no_outliers <- london_spatial_no_outliers %>%
  add_column(city = "london")

paris_spatial_no_outliers["attraction_rating"] <- cut(paris_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
paris_spatial_no_outliers <- paris_spatial_no_outliers %>%
  add_column(city = "paris")

rome_spatial_no_outliers["attraction_rating"] <- cut(rome_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
rome_spatial_no_outliers <- rome_spatial_no_outliers %>%
  add_column(city = "rome")

vienna_spatial_no_outliers["attraction_rating"] <- cut(vienna_spatial_no_outliers$attr_index_norm, breaks=c(0, 5, 15, 25, 100), labels=c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
vienna_spatial_no_outliers <- vienna_spatial_no_outliers %>%
  add_column(city = "vienna")

cluster_city <- bind_rows(amsterdam_spatial_clusters, athens_spatial_clusters, barcelona_spatial_clusters, berlin_spatial_clusters, budapest_spatial_clusters, lisbon_spatial_clusters, london_spatial_clusters, paris_spatial_clusters, rome_spatial_clusters, vienna_spatial_clusters)

fig_city_spatial <- bind_rows(amsterdam_spatial_no_outliers, athens_spatial_no_outliers, barcelona_spatial_no_outliers, berlin_spatial_no_outliers, budapest_spatial_no_outliers, lisbon_spatial_no_outliers, london_spatial_no_outliers, paris_spatial_no_outliers, rome_spatial_no_outliers, vienna_spatial_no_outliers)

ui <- fluidPage(
  titlePanel("Analyzing Airbnb Spatial Trends Across European Cities Using K-means Clustering"),
   sidebarLayout(
    sidebarPanel(
      # Dropdown box for city
    selectInput("city", label = "City:",
              choices= unique(fig_city_spatial$city)),
      # Slider range for price
    sliderInput("realSum", label = "Price of Rental", min = 0, 
        max = 1300, value = c(0, 1300)),
      # Checkbox for day of the week
    checkboxGroupInput("attraction_rating", label = "Attraction Rating", 
    choices= c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"), selected =c("Ok (0-5)", "Good (6-15)", "Very Good (16-25)", "Amazing (26-100)"))
    ),
  mainPanel(
     plotlyOutput("scatterplot"),
     plotlyOutput("clusterplot")
    )
  ))
server <- function(input, output){
  
   output$scatterplot <- renderPlotly({
     
     fig_city_spatial <- fig_city_spatial %>% filter(attraction_rating %in% input$attraction_rating)
     fig_city_spatial <- subset(fig_city_spatial, realSum >= min(input$realSum) & realSum <= max(input$realSum))
     
      fig8 <- fig_city_spatial[fig_city_spatial$city==input$city,]
      fig8 <- fig8 %>%
        plot_ly(
          lat = ~lat,
          lon = ~lng,
          mode = "markers",
          colors = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", "5"="#fa7921"),
          color = ~Cluster,
          type = 'scattermapbox',
          hovertext = ~paste("Price: ", realSum) ,
          legendgroup = ~Cluster, 
          showlegend = T)
      fig8 <- fig8 %>%
        layout(
          mapbox = list(
            style = 'open-street-map',
            zoom = 10,
            center = list(lon = ~median(lng), lat = ~median(lat))))
  })
   
   output$clusterplot <- renderPlotly({
      spatial_clusters <- cluster_city[cluster_city$city==input$city,]
      p <- ggparcoord(data = spatial_clusters, columns = c(2:8), groupColumn = 1, scale = "std") + labs(x = "Attributes", y = "value (in standard-deviation units)", title = "Clustering") +
      scale_color_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                    "5"="#fa7921")) +
        theme_bw()
      ggplotly(p)
  })
}
shinyApp(ui = ui, server = server, options = list(width = 1000, height = 1000))
```
The scatter map plot displays the clusters of each city’s Airbnb listings, calculated using k-means. The parallel coordinate plot shows the trends for each cluster, allowing better interpretation of the cluster meanings.

## Discussion
Not much can be drawn just looking at the map with the clusters, which is why we created a supplementary chart that shows the trends for each cluster. While there are differing numbers of clusters for each city, overall there is a trend of the expensive Airbnbs being the closest to attractions (lower distance from city center / metro, high attraction index and restaurant index), while the cheaper ones are further away. Moreover, when we filter with the attraction index checkboxes, we also see that Airbnbs closer to the center of the city have higher attraction indexes. 

# Question 2
How do weekday and weekend rental rates for Airbnb bookings compare for vacationers and business travelers?

## Chart
```{r}
fig_city <- bind_rows(amsterdam, athens, barcelona, berlin, budapest, lisbon, london, paris, rome, vienna)
fig_city <- unique(fig_city)
# Delete unnecessary columns from dataset
fig_city <- fig_city[,!names(fig_city) %in% 
      c("X", "rest_index", "rest_index_norm", "room_shared", "room_private", "metro_dist")]
# Reorder columns
col_order <- c("city", "dayofweek", "lat",
               "lng", "realSum", "room_type", "dist", "person_capacity", "bedrooms", "host_is_superhost", "multi", "biz", "cleanliness_rating", 
               "guest_satisfaction_overall", "attr_index", "attr_index_norm")
fig_city <- fig_city[, col_order]
# Remove shared rooms; too small amount of data for proper analysis
fig_city <- fig_city %>%
  filter(room_type != 'Shared room')

ui <- fluidPage(
  titlePanel("Question 2: Comparison between Vacation and Business Airbnb Rentals"),
   sidebarLayout(
    sidebarPanel( 
     selectInput("city", label = "City:",
              choices= unique(fig_city$city)),
      # Slider range for price
    sliderInput("realSum", label = "Price of Rental", min = 0, 
        max = 1000, value = c(0, 1000)),
      # Checkbox for day of the week
    checkboxGroupInput("dayofweek", label = "Weekday vs. Weekend Rental", 
    choices= unique(fig_city$dayofweek), selected = c("weekday", "weekend")),
      # Checkbox for room type
    checkboxGroupInput("room_type", label = "Rental Room Type", 
    choices= unique(fig_city$room_type), selected = c("Private room", "Entire home/apt")),
    # Radio button for trend lines
    radioButtons("trend_lines", label = "Trend Lines", 
    choices= c("No trend", "Overall trend", "All trends"), selected = "No trend")
  ),
    mainPanel(
      tabsetPanel(
      tabPanel("Trend Scatterplot", plotOutput("scatterplot")),
      tabPanel("Violin and Boxplot", plotOutput("violinplot")),
      tabPanel("Data", dataTableOutput("data_table")),
      tabPanel("Variable Summary", verbatimTextOutput("summary_var")))
  )))
server <- function(input, output){
    
    output$scatterplot <- renderPlot({
     
     fig_city <- fig_city %>% filter(between(realSum, min(input$realSum), max(input$realSum)))
     fig_city <- fig_city %>% filter(dayofweek %in% input$dayofweek)
     fig_city <- fig_city %>% filter(room_type %in% input$room_type)
     newbiz <- c("0" = "Vacation", "1" = "Business")
     
    graph1 <- ggplot(fig_city[fig_city$city==input$city,], aes(x=dist, y=realSum, color=room_type)) +
      geom_point(alpha=0.3) + facet_grid(biz~., labeller = labeller(biz = newbiz)) +
      xlab("Distance from City Center (km)") + ylab("Price of Airbnb (USD)") + 
      ggtitle("Graph 2: Relationship between Airbnb Price, Location, and Purpose of Rental") + 
      theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1)) +
      ylim(min(input$realSum), max(input$realSum)) +
      xlim(0, 10) +
      theme_bw() + scale_color_manual(values =  c("Private room"='coral',
        "Entire home/apt"='lightblue')) +
       labs(caption = "The figure above demonstrates a slight negative/inverse trend between Airbnb price and distance from the city center regardless of travel 
       purpose (vacation vs. business). The trend is robust against changes in the data manipulated using the widgets. Users can visualize the trend across 
       other secondary factors such as type of room rental, European city, price limits, and whether it is a 
       weekend or weekday rental. The trend lines also demonstrate a 95% confidence band around the trend lines.") +
       theme(plot.caption = element_text(face = "bold"))
    
    if(input$trend_lines == "No trend"){
      graph1
    } else if(input$trend_lines == 'Overall trend'){
      graph1 + geom_smooth(aes(group=NA), method=lm, color='black')
    } else if (input$trend_lines == 'All trends'){
      graph1 + geom_smooth(aes(linetype=room_type), method=lm, color='black') +
        scale_linetype_manual(values=c("longdash", "twodash"))
    }
    
  })
    
    output$violinplot <- renderPlot({
     
     fig_city <- fig_city %>% filter(between(realSum, min(input$realSum), max(input$realSum)))
     fig_city <- fig_city %>% filter(dayofweek %in% input$dayofweek)
     fig_city <- fig_city %>% filter(room_type %in% input$room_type)
     newbiz <- c("0" = "Vacation", "1" = "Business")
     
     ggplot(fig_city[fig_city$city==input$city,], aes(x=room_type, y=dist, color=room_type)) + 
      geom_boxplot(scale="width", lwd=1, outlier.shape=NA) + coord_flip() + xlab("Room Type") + ylab("Distance from City Center (km)") +
      geom_violin(scale="width", fill=alpha("grey",0.5), color=NA) + coord_flip() +
      facet_grid(biz~., labeller = labeller(biz = newbiz)) +
      ggtitle("Graph 2.1: The Relationship Between Location and Purpose of Rental") + 
      theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1)) +
      ylim(0, 10) +
      theme_bw() +
      scale_color_manual(values =  c("Private room"='coral',
        "Entire home/apt"='lightblue')) +
       guides(color = guide_legend(order = 1), size = guide_legend(order = 2)) +
       labs(caption = "As an extension of the first graph, the chart above demonstrates the relationship between Airbnb location 
            and purpose of rental when considering factors such as city, price, and time of week. While a relationship exists 
            between all Airbnb rentals and distance from the city center, this trend is more profound with business rather than vacation rentals.") +
       theme(plot.caption = element_text(face = "bold"))
  })
    
    output$data_table <- renderDataTable({
      fig_city <- fig_city %>% filter(between(realSum, min(input$realSum), max(input$realSum)))
      fig_city <- fig_city %>% filter(dayofweek %in% input$dayofweek)
      fig_city <- fig_city %>% filter(room_type %in% input$room_type)
      fig_city[fig_city$city==input$city, c("city", "dayofweek", "room_type", "realSum", "person_capacity", "bedrooms", "dist", "attr_index")]
    })
    
    output$summary_var <- renderPrint({
      fig_city <- fig_city %>% filter(between(realSum, min(input$realSum), max(input$realSum)))
      fig_city <- fig_city %>% filter(dayofweek %in% input$dayofweek)
      fig_city <- fig_city %>% filter(room_type %in% input$room_type)
      summary(fig_city[fig_city$city==input$city, c("realSum", "person_capacity", "bedrooms", "dist", "attr_index")])
    })
}
shinyApp(ui = ui, server = server, options = list(width = 1000, height = 1000)) 
```
The investigation into the differences between Airbnb travel purposes relies on two graphical analyses. An initial graph was created to demonstrate any linear trend between price and distance from the city center between vacation and business rentals. As an extension of this examination, the boxplot and violin plot demonstrates the differences between business and vacation rentals. Both use facets to compare the different features between business and vacation listings, with additional widgets implemented to account for secondary factors which may influence rentals such as type of room rental, European city, price limits, and whether it is a weekend or weekday rental.  

## Discussion
The primary scatterplot graph suggests a slight negative/inverse trend between Airbnb price and distance from the city center regardless of travel purpose (vacation vs. business). The overall trend line and individual lines for room type both illustrate that rental price has an inverse relationship with distance: the closer to the city center a property is, the more expensive it often is. While one might expect larger properties in the suburbs to be worth more in rent, it seems like one large determinant of price is location. Vacationers and business people alike seek out listings that are convenient to the metropolitan center. The prevalence of rental observations/points within 5km of the city center further shows the importance of location. Airbnb rentals are clustered tightly, however, vacation rentals are more spread out over the metropolitan area while rentals for business purposes tend to be closer to the city center. A secondary factor which may influence price as illustrated by the scatterplot is the type of room up for rent: the Airbnb rentals that offer the entire home or apartment are also more costly than private room rentals. As a final note, the trend lines between rental purposes are remarkably similar, yet the vacation rental trend lines are more robust and have a smaller confidence interval because Airbnb hosts more listings for vacation than business rentals. There are, however, more business listings on weekdays which fits with the typical assumption of necessity and demand during the typical business work week. 

The boxplot and violin plot is an extension of the first graph, revealing the relationship between Airbnb location and purpose of rental when considering factors such as city, price, and time of week. Whereas the first graph relied on predicting a relationship of price and location between the two purposes of renting, a secondary graph is needed to further illustrate the differences in location amongst vacation and business rentals. Instead of assuming a relationship exists by identifying groups of observations clustering on a scatterplot, a violin plot and boxplot were created in order to demonstrate the distance distribution and density of rental listings. This analysis supports the conclusions made from the prior graph: vacation rentals are more spread out over the metropolitan area, while rentals for business purposes tend to cluster closely around the city center. While little can be said about the differences between the room type (there is little to distinguish when comparing private room vs. entire home within vacation or business rentals), there is a positive association between business rentals and metropolitan location. People conducting business affairs are needed in the city, while individuals on vacation can afford to commute while they are exploring. This conclusion is also understandable in the context of the Airbnb dataset which hosts a larger amount and more variation of vacation listings. 

# Conclusion


# Appendix
## Chart 1 Justification
K-means clustering was selected because we wanted to examine and group Airbnbs by spatial trends (distance from city center and metro, attraction index, restaurant index) and price. The purpose of clustering analysis is to identify patterns in your data and create groups according to those patterns. Therefore, if two points have similar characteristics, that means they have the same pattern and consequently, they belong to the same group. By doing clustering analysis we were able to check what features usually appear together and see what characterizes a cluster for each city.

To determine the best number of clusters for each city, we used the fviz_nbclust() to determine and visualize the optimal number of clusters. For each city the function determined that 2 was the best number of clusters. However, we wanted to see if certain cities could use more clusters and still get valid results. Therefore, we used fviz_cluster to further visualize the clusters and test different numbers of clusters for each city. We wanted to ensure that clusters did not overlap and were distinct from each other, and the clusters we ended with for each city were based on these results. 

```{r}
fviz_nbclust(amsterdam_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(athens_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(barcelona_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(berlin_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(budapest_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(lisbon_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(london_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(paris_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(rome_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
fviz_nbclust(vienna_spatial_no_outliers[,1:9], kmeans, method = "silhouette")
```

```{r}
fviz_cluster(final_amsterdam, data = amsterdam_spatial_no_outliers[,1:9], main = "Amsterdam") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_athens, data = athens_spatial_no_outliers[,1:9], main = "Athens") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_barcelona, data = barcelona_spatial_no_outliers[,1:9], main = "Barcelona") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_berlin, data = berlin_spatial_no_outliers[,1:9], main = "Berlin") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_budapest, data = budapest_spatial_no_outliers[,1:9], main = "Budapest") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_lisbon, data = lisbon_spatial_no_outliers[,1:9], main = "Lisbon") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_london, data = london_spatial_no_outliers[,1:9], main = "London") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_paris, data = paris_spatial_no_outliers[,1:9], main = "Paris") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_rome, data = rome_spatial_no_outliers[,1:9], main = "Rome") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()

fviz_cluster(final_vienna, data = vienna_spatial_no_outliers[,1:9], main = "Vienna") +
  scale_colour_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  scale_fill_manual(values = c("1"="#ff595e", "2"="#ffca3a", "3"="#1982c4", "4"="#8ac926", 
                                 "5"="#fa7921")) +
  theme_bw()
```

We selected the scatter map plot to display the clusters, as a map was the best visualization for what the clusters looked like spatially. However, this chart was not enough to interpret what the clusters meant, so we included a supplemental chart: the parallel coordinate plot, which shows the trends for each cluster, allowing better interpretation of the cluster meanings.

The widgets we used served to filter the display of the scatter map plot. The dropdown widget was used to select which city we wanted to cluster and see on the map. The weekday and weekend checkboxes were used to change the view of the clusters depending on whether the listing is from the weekday or weekend. This is necessary because some Airbnbs from the same location have both weekday and weekend listings, and therefore their prices differ. The attraction rating checkboxes were used to change the display of Airbnbs based on their attraction index, allowing the user to better visualize the difference in clusters when examining Airbnb locations. The price slider was used to adjust the view of the clusters based on the price of the listings. 


## Chart 2 Justification
The conjunction of a scatterplot and boxplot/violin plot was chosen for this question because it does a more thorough job of showing the relationship between variables than any individual graph. These graphs adequately highlight the trend between the cost of a listing, its distance from the city center, and the type of listing (whether that be room type or motive behind renting). As well as including widgets to be able to see the differences between the variables used, the graphs were faceted to clearly display a side-by-side image of business vs vacation rentals. All decisions in the creation of these illustrations were made for the benefit of an audience as argued by How Charts Lie. Additionally, these specifications help narrow down the amount of information that is displayed and denote a visible pattern between distance, price, and rental type.

Multiple unique widgets were used to exhibit the differences between a variety of factors real consumers must consider: traveling to different cities, day of the week, price, room type, and if the listing is for business or vacation purposes. The dropdown selection was used to select which city to view. The slider for price displays the range of acceptable cost to be shown on the graph in order to simulate real price considerations of travelers; this range the user chooses subsets the graph to only show what has been selected. The checkbox for weekday/weekend was used to select whether the user wants to see rental information for weekdays or weekends. The checkbox for room type also gave the user choice in deciding what type of room they wanted to view. The different colors for room type showed the differences between the listings. The checkbox widgets gave the user the option to select both or multiple of the choices in the case that they do not have a preference or want variability. A radio button was also used to visualize the trend lines on the scatterplot. In this regard, the use of widgets also often mitigated the busyness of the original graph as users subsetted and hid trend lines. 


## References
[1] https://ec.europa.eu/eurostat/web/products-eurostat-news/w/ddn-20230118-1

[2] https://www.unwto.org/news/tourism-recovery-accelerates-to-reach-65-of-pre-pandemic-level